Хочу поделиться опытом придания Yandex Алисе (внутри умных колонок поддерживающих TTS API) своевольности. Про локальный API колонок уже писали на хабре тут https://habr.com/ru/post/508106/

Идея заключается в том чтобы Алиса реагировала на присутствующих людей. Для этого их необходимо идентифицировать. Так же Алиса в случайное время будет выдавать некоторую «отсебятину». В репозитории использован самый простой (на мой взгляд) вариант – тренировка модели в Google Teachable Machine. Использован модуль для Node-Red который позволяет посылать команды, управлять воспроизведением и отправлять на яндекс станцию текст который она произнесет.

Инструменты:
1.	Node-Red
2.	Python3
3.	OpenCV
4.	Tensorflow Keras
5.	Google Teachable Machine
6.	PostgresSQL
7.	MQTT

![Sheme](/images/sheme.png)

1)	Скрипт распознает лица и отправляет процент совпадения для каждой сущности модели в MQTT брокер, а так же сохраняет снимок в директорию из файла конфигурации

2)	Node-Red получает сообщения из MQTT брокера и отправляет Алисе команду что либо сказать в зависимости от времени суток и того как давно она “видела” этого человека. При этом фразы для Алисы, а так же время когда человек последний раз засветился на камеру хранятся в БД Postgres.

# Установка

**Linux:**
```
pip3 install opencv-python tensorflow
```
Возможно портебуется установка дополнительных пакетов
```
sudo apt-get install git python3-dev 
```
Загружаем приложение
```
git clone https://github.com/guinmoon/yandex_alice_has_fun
cd yandex_alice_has_fun 
```

# Настройка

Настройки alice_has_fun.py хранятся в файле config.json:
```
{
    "debug": false,
    "show_camera": false,
    "input_sounrce": 0,
    "frame_recognition_rate": 4,
    "publish_min_dalay": 1,
    "camera_w": 1080,
    "camera_h": 720,
    "mqtt_broker": "127.0.0.1",
    "save_on_detect": true
}
```
| Параметр               |                                                              Назначение                                                              |
| ---------------------- | :----------------------------------------------------------------------------------------------------------------------------------: |
| debug                  |                                         Елси True то рзультаты не публикуются в MQTT брокер                                          |
| show_camera            |                                  Елси True то с помощью cv2.imshow отображается видео из источника                                   |
| input_sounrce          | Число (0 это первая веб камера), адрес потока ("rtsp://192.168.1.86:8554/unicast") или расположение видео файла ("raw/IMG_2404.MOV") |
| frame_recognition_rate |                                                Частота распознавания кадров в секунду                                                |
| publish_min_dalay      |                            Задержка перед публикацией, публикуются средние значения из распознаных кадров                            |
| camera_w               |                                  Ширина видео для устройств поддерживающих задание разрешения видео                                  |
| camera_h               |                                  Высота видео для устройств поддерживающих задание разрешения видео                                  |
| mqtt_broker            |                                                          Адрес MQTT брокера                                                          |
| save_on_detect         |                             Помимо публикации в брокер также будет сохранен кадр в директорию on_detect                              |
# Запуск

```python3 alice_has_fun.py```